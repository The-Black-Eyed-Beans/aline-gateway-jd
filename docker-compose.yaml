version: "3.9"

x-aws-vpc: ${VPC}
x-aws-cluster: ${CLUSTER}
x-aws-loadbalancer: ${LOAD_BALANCER}

services:
  gateway:
    image: $AWS_ACCOUNT_ID.dkr.ecr.$ECR_REGION.amazonaws.com/gateway-jd:latest
    ports:
      - target: 443
        x-aws-protocol: https
    environment:
      - APP_SERVICE_HOST=${APP_SERVICE_HOST}
      - APP_PORT=443
    networks:
      - public
      - private
networks:
  public:
    external: true
    name: ${SG_PUBLIC}
  private:
    external: true
    name: ${SG_PRIVATE}

x-aws-cloudformation:
  Resources:
    GatewayService:
      Properties:
        NetworkConfiguration:
          AwsvpcConfiguration:
            Subnets:
              - ${SUBNET_ONE}
              - ${SUBNET_TWO}
    Gateway443TargetGroup:
      Properties:
        HealthCheckPath: /health
        Matcher:
          HttpCode: 200-499
    Gateway443Listener:
      Properties:
        Protocol: HTTPS
        Certificates:
          - CertificateArn: ${SSL_CERT}
